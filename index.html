<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Water Dashboard</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0px;
            min-height: 100vh;
            background: linear-gradient(135deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #f5576c 75%, 
                #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            padding: 0;
            overflow-x: hidden;
        }
        
        html {
            scroll-behavior: smooth;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .glass:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 20px 40px;
            position: sticky;
            top: 0px;
            z-index: 1000;
            margin: 0px;
            overflow: hidden;
            border-radius: 0px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .nav-logo {
            font-size: 28px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 30px;
            margin: 0;
            padding: 0;
        }

        .nav-links li a {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            font-size: 16px;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-links li a:hover {
            color: rgba(255, 255, 255, 1);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .explainer {
            max-width: 800px;
            margin: 0 0 30px 0;
            line-height: 1.6;
            text-align: justify;
            color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            background: transparent;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .explainer h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .dashboard-header h1 {
            font-size: 36px;
            font-weight: 600;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
       
        #dashboard-offset {
            height: 100px; /* sama dengan tinggi navbar */
            margin-top: -100px;
        }

        .date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-role {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }

        .username {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .kpi-card {
            padding: 30px;
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            border-radius: 20px;
            z-index: -1;
        }

        .kpi-card h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
        }

        .kpi-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .kpi-card .change {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .kpi-card.alert {
            background: rgba(220, 53, 69, 0.15);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .kpi-card.alert .value {
            color: #ff6b6b;
        }

        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            padding: 30px;
            border-radius: 20px;
            min-height: 350px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.12) 0%, 
                rgba(255, 255, 255, 0.08) 100%);
            border-radius: 20px;
            z-index: -1;
        }

        .chart-container h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .flowRate-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        /* Floating animation for cards */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .kpi-card:nth-child(1) {
            animation: float 6s ease-in-out infinite;
        }

        .kpi-card:nth-child(2) {
            animation: float 6s ease-in-out infinite 2s;
        }

        .kpi-card:nth-child(3) {
            animation: float 6s ease-in-out infinite 4s;
        }

        /* Glow effects */
        .glow {
            position: relative;
        }

        .glow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(255, 255, 255, 0.1), 
                rgba(255, 255, 255, 0.05));
            border-radius: 22px;
            z-index: -1;
            filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .glow:hover::after {
            opacity: 1;
        }

        /* Flow rates and consumption grid styles */
        .flow-rates-grid, .consumption-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .flow-box, .consumption-box {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .flow-box:hover, .consumption-box:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .flow-box .value, .consumption-box .value {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.95);
        }

        .flow-label, .consumption-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }
        
        .time-range-selector {
                margin: 20px 0;
                padding: 20px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                text-align: center;
                transition: all 0.3s ease;
            }
            
            .time-range-selector:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateY(-2px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }
            
            .selector-label {
                color: rgba(255, 255, 255, 0.9);
                font-size: 16px;
                font-weight: 500;
                margin-bottom: 15px;
                display: block;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }
            
            .range-buttons {
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .range-btn {
                padding: 12px 20px;
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                color: rgba(255, 255, 255, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 12px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                min-width: 60px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }
            
            .range-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s;
            }
            
            .range-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                border-color: rgba(255, 255, 255, 0.4);
                color: rgba(255, 255, 255, 1);
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            }
            
            .range-btn:hover::before {
                left: 100%;
            }
            
            .range-btn.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-color: rgba(255, 255, 255, 0.3);
                color: #ffffff;
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            }
            
            .range-btn.active::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
                border-radius: 12px;
                pointer-events: none;
            }
            
            .range-btn:active {
                transform: translateY(-1px);
                transition: transform 0.1s;
            }
            
            @media (max-width: 768px) {
                .range-buttons {
                    gap: 8px;
                }
                
                .range-btn {
                    padding: 10px 16px;
                    font-size: 13px;
                    min-width: 50px;
                }
                
                .time-range-selector {
                    padding: 15px;
                    margin: 15px 0;
                }
            }

        /* Responsive design for new grids */
        @media (max-width: 768px) {
            .navbar {
                margin: 10px;
                padding: 15px 20px;
            }

            .nav-links {
                gap: 15px;
            }

            .nav-links li a {
                font-size: 14px;
                padding: 6px 12px;
            }

            .container {
                padding: 15px;
            }

            .explainer h1 {
                font-size: 28px;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .flow-rates-grid, .consumption-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .chart-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-container {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-logo"><strong>WaterWwateran Dashboard</strong></div>
         <ul class="nav-links">
            <li><a href="#dashboard-offset">Dashboard</a></li>
            <li><a href="index2.html">Monthly Analysis</a></li>
            <li><a href="index3.html">Efficiency & Tips</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="explainer">
            <h1>Welcome, Adrian Aryaputra</h1>
            <p>This dashboard provides a comprehensive overview of Water management, tracking key metrics like Flowrates, total water consumed, and management performance in real time.</p>
            <br>
            <p>The Real-time flow rate graph visualizes current water usage, while device usage distribution chart comparing most water consuming areas, and daily usage by device graph highlighting total water usage to help analyze user behavior.</p>
        </div>
        <div id="dashboard-offset"></div>
            <section id="dashboard">
            </section>
        
        <div id="header" class="dashboard-header glass glow">
            <div>
                <h1>Water Dashboard</h1>
                <p class="date" id="lastUpdate">May 28, 2025</p>
            </div>
            <div class="user-info">
                <span class="user-role">Adrian Aryaputra</span>
                <span class="username">(221311003)</span>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card glass glow">
                <h3>Current Flow rate 
                <svg class="flowRate-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"></path>
                </svg></h3>
                <div class="flow-rates-grid">
                    <div class="flow-box">
                        <div class="value" id="flowRate1">0 L/min</div>
                        <p class="flow-label">Toilet</p>
                    </div>
                    <div class="flow-box">
                        <div class="value" id="flowRate2">0 L/min</div>
                        <p class="flow-label">Faucet</p>
                    </div>
                    <div class="flow-box">
                        <div class="value" id="flowRate3">0 L/min</div>
                        <p class="flow-label">Garden</p>
                    </div>
                </div>
            </div>
            <div class="kpi-card glass glow">
                <h3>Total Consumption</h3>
                <div class="consumption-grid">
                    <div class="consumption-box">
                        <p class="value"><span id="totalWater1">0</span> L</p>
                        <p class="consumption-label">Toilet</p>
                    </div>
                    <div class="consumption-box">
                        <p class="value"><span id="totalWater2">0</span> L</p>
                        <p class="consumption-label">Faucet</p>
                    </div>
                    <div class="consumption-box">
                        <p class="value"><span id="totalWater3">0</span> L</p>
                        <p class="consumption-label">Garden</p>
                    </div>
                </div>
                <p class="change" id="totalTrend">↗ 0% vs yesterday</p>
            </div>
            <div class="kpi-card glass glow alert">
                <h3>Usage Alerts</h3>
                <p class="value"><span id="alerts">0</span> Active</p>
                <p class="change" id="alertDevice">-</p>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-container glass glow">
                <h3>Real-time Flow Rate</h3>
                <div id="flowChart" style="height: 300px;"></div>
            </div>
            <div class="chart-container glass glow">
                <h3>Device Usage Distribution</h3>
                <div id="deviceChart" style="height: 300px;"></div>
            </div>
            <div class="chart-container glass glow">
                <h3>Daily Usage by Device</h3>
                <div id="dailyChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/10.3.3/highcharts.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script>
        // ======================
        // Supabase Configuration
        // ======================
        const supabaseUrl = 'https://hslsweymoroniqzjluse.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzbHN3ZXltb3JvbmlxempsdXNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3MDgzOTQsImV4cCI6MjA2MjI4NDM5NH0.RxN7hDAWpyuUFdHFfSXKgJZhWQJPFWulDTT-496Y-c8'
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

        // ======================
        // Configuration
        // ======================
        let currentDeviceIndex = 0;
        let selectedDevice = 'all';
        let alertCount = 0;
        const devices = ['toilet', 'faucet', 'garden'];
        const colors = {
            toilet: '#de5d83',    // Red
            faucet: '#13bbaf',    // Blue
            garden: '#fff7e7',    // Yellow
            all: '#4facfe'
        };

        // Time range configuration
        let selectedTimeRange = 300; // Default: 5 minutes
        const timeRanges = {
            15: { seconds: 15, label: '15s', maxPoints: 15 },
            300: { seconds: 300, label: '5m', maxPoints: 100 },
            3600: { seconds: 3600, label: '1h', maxPoints: 360 },
            21600: { seconds: 21600, label: '6h', maxPoints: 720 },
            86400: { seconds: 86400, label: '24h', maxPoints: 1440 }
        };

        let timeLabels = [];
        let flowData = [];
        let totalData = [];

        const loadingElement = document.getElementById("loading");
        const errorElement = document.getElementById("errorMessage");
        const flowBox = document.getElementById("flowBox");

        // Device Data Storage - Enhanced to store more historical data
        let devicesData = {};
        let allHistoricalData = {}; // Store all data points for different time ranges
        let flowChart, deviceChart, dailyChart;

        // ======================
        // Supabase Functions
        // ======================
        async function getDataFromSupabase(timeRangeSeconds = 300) {
            try {
                const startTime = new Date(Date.now() - (timeRangeSeconds * 1000)).toISOString();
                
                const { data, error } = await supabaseClient
                    .from('flow_data') // Replace with your actual table name
                    .select('*')
                    .gte('timestamp', startTime)
                    .order('timestamp', { ascending: true });

                if (error) {
                    console.error('Error fetching data:', error);
                    return null;
                }
                
                return data;
            } catch (err) {
                console.error('Supabase fetch error:', err);
                return null;
            }
        }

        async function getLatestDataFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('flow_data')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(3); // Get latest data for each device

                if (error) {
                    console.error('Error fetching latest data:', error);
                    return null;
                }
                
                return data;
            } catch (err) {
                console.error('Supabase latest data fetch error:', err);
                return null;
            }
        }

        // Alternative: Fetch data from your PHP endpoint instead of directly from Supabase
        async function getDataFromPHP() {
            try {
                const response = await fetch('/api/get-data', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    return result.devices;
                } else {
                    console.error('PHP endpoint error:', result.message);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching from PHP:', error);
                return null;
            }
        }

        // ======================
        // Fixed Data Processing
        // ======================
        function updateLocalDeviceData(deviceName, flowRate, total) {
            const now = Date.now();
            
            // Ensure flowRate and total are numbers
            const safeFlowRate = Number(flowRate) || 0;
            const safeTotal = Number(total) || 0;
            
            const newPoint = [now, parseFloat(safeFlowRate.toFixed(2))];
            
            // Initialize device data if not exists
            if (!devicesData[deviceName]) {
                devicesData[deviceName] = {
                    flow: [],
                    daily: 0
                };
                allHistoricalData[deviceName] = [];
            }
            
            // Add to historical data - ensure it's a proper array
            if (Array.isArray(allHistoricalData[deviceName])) {
                allHistoricalData[deviceName].push(newPoint);
            } else {
                allHistoricalData[deviceName] = [newPoint];
            }
            
            // Update daily consumption with the total from microcontroller
            devicesData[deviceName].daily = parseFloat(safeTotal.toFixed(2));
            
            // Keep only last 2000 points in historical data to prevent memory issues
            if (allHistoricalData[deviceName].length > 2000) {
                allHistoricalData[deviceName] = allHistoricalData[deviceName].slice(-1000);
            }
        }

        // ======================
        // Time Range Functions
        // ======================
        function createTimeRangeSelector() {
            // Create glassmorphism time range selector with CSS
            const selectorHTML = `
                <style>
                    .time-range-selector {
                        margin: 20px 0;
                        padding: 20px;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        border-radius: 16px;
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                        text-align: center;
                        transition: all 0.3s ease;
                    }
                    
                    .time-range-selector:hover {
                        background: rgba(255, 255, 255, 0.15);
                        transform: translateY(-2px);
                        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
                    }
                    
                    .selector-label {
                        color: rgba(255, 255, 255, 0.9);
                        font-size: 16px;
                        font-weight: 500;
                        margin-bottom: 15px;
                        display: block;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                    }
                    
                    .range-buttons {
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        flex-wrap: wrap;
                    }
                    
                    .range-btn {
                        padding: 12px 20px;
                        background: rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        color: rgba(255, 255, 255, 0.8);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: 12px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        position: relative;
                        overflow: hidden;
                        min-width: 60px;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                    }
                    
                    .range-btn::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                        transition: left 0.5s;
                    }
                    
                    .range-btn:hover {
                        background: rgba(255, 255, 255, 0.2);
                        border-color: rgba(255, 255, 255, 0.4);
                        color: rgba(255, 255, 255, 1);
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
                    }
                    
                    .range-btn:hover::before {
                        left: 100%;
                    }
                    
                    .range-btn.active {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-color: rgba(255, 255, 255, 0.3);
                        color: #ffffff;
                        transform: translateY(-3px);
                        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                    }
                    
                    .range-btn.active::after {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
                        border-radius: 12px;
                        pointer-events: none;
                    }
                    
                    .range-btn:active {
                        transform: translateY(-1px);
                        transition: transform 0.1s;
                    }
                    
                    @media (max-width: 768px) {
                        .range-buttons {
                            gap: 8px;
                        }
                        
                        .range-btn {
                            padding: 10px 16px;
                            font-size: 13px;
                            min-width: 50px;
                        }
                        
                        .time-range-selector {
                            padding: 15px;
                            margin: 15px 0;
                        }
                    }
                </style>
                <div class="time-range-selector">
                    <span class="selector-label"> Time Range</span>
                    <div class="range-buttons">
                        ${Object.entries(timeRanges).map(([key, range]) => 
                            `<button class="range-btn ${key == selectedTimeRange ? 'active' : ''}" 
                                    onclick="changeTimeRange(${key})">
                                ${range.label}
                            </button>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            // Insert before the chart
            const chartContainer = document.getElementById('flowChart');
            if (chartContainer && !document.querySelector('.time-range-selector')) {
                chartContainer.insertAdjacentHTML('beforebegin', selectorHTML);
            }
        }

        async function changeTimeRange(newRange) {
            selectedTimeRange = newRange;
            
            // Update button states
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Fetch data from Supabase for the new time range
            await loadDataFromSupabase();
            updateCharts();
            console.log(`Time range changed to: ${timeRanges[newRange].label}`);
        }

        async function loadDataFromSupabase() {
            try {
                showLoading(true);
                const data = await getDataFromSupabase(selectedTimeRange);
                
                if (data && data.length > 0) {  
                    // Reset device data
                    devices.forEach(device => {
                        devicesData[device] = { flow: [], daily: 0 };
                        allHistoricalData[device] = [];
                    });
                    
                    // Process the fetched data
                    data.forEach(record => {
                        const timestamp = new Date(record.timestamp).getTime();
                        const deviceName = record.device_name;
                        const flowRate = record.flow_rate;
                        const totalConsumed = record.total_consumed;
                        
                        if (devices.includes(deviceName)) {
                            // Add to historical data
                            allHistoricalData[deviceName].push([timestamp, flowRate]);
                            
                            // Update daily consumption with latest total
                            devicesData[deviceName].daily = Math.max(devicesData[deviceName].daily, totalConsumed);
                        }
                    });
    
                }
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                showError('Failed to load data from database');
                showLoading(false);
            }
        }

        function filterDataByTimeRange() {
            const now = Date.now();
            const rangeMs = selectedTimeRange * 1000; // Convert to milliseconds
            const cutoffTime = now - rangeMs;
            
            // Filter data for each device based on selected time range
            devices.forEach(device => {
                if (allHistoricalData[device]) {
                    devicesData[device].flow = allHistoricalData[device]
                        .filter(point => point[0] >= cutoffTime)
                        .slice(-timeRanges[selectedTimeRange].maxPoints); // Limit points for performance
                }
            });
            
            // Calculate 'all' data
            const allFlowData = [];
            const maxLength = Math.max(...devices.map(device => devicesData[device].flow.length));
            
            for (let i = 0; i < maxLength; i++) {
                let totalFlow = 0;
                let timestamp = null;
                
                devices.forEach(device => {
                    if (devicesData[device].flow[i]) {
                        totalFlow += devicesData[device].flow[i][1];
                        timestamp = devicesData[device].flow[i][0];
                    }
                });
                
                if (timestamp !== null) {
                    allFlowData.push([timestamp, totalFlow]);
                }
            }
            
            if (!devicesData.all) {
                devicesData.all = { flow: [], daily: 0 };
            }
            devicesData.all.flow = allFlowData;
            devicesData.all.daily = devices.reduce((sum, device) => sum + devicesData[device].daily, 0);
        }

        // ======================
        // Chart Initialization
        // ======================
        function initCharts() {
            // Create time range selector first
            createTimeRangeSelector();
            
            // Real-time Flow Chart (Line) - Now shows all 3 devices separately
            flowChart = Highcharts.chart('flowChart', {
                chart: {
                    type: 'spline',
                    backgroundColor: 'transparent',
                    animation: false,
                    zoomType: 'x' // Allow zooming
                },
                title: { 
                    text: `Real-time Flow Rate (${timeRanges[selectedTimeRange].label})`, 
                    style: { color: '#fff' } 
                },
                xAxis: {
                    type: 'datetime',
                    labels: { 
                        style: { color: '#ddd' },
                        formatter: function() {
                            // Create a proper Date object to handle local timezone
                            const localTime = new Date(this.value);
                            // Format labels based on time range
                            if (selectedTimeRange <= 300) { // 15s and 5m
                                return localTime.toLocaleTimeString('en-US', { 
                                    hour12: false, 
                                    hour: '2-digit', 
                                    minute: '2-digit', 
                                    second: '2-digit' 
                                });
                            } else if (selectedTimeRange <= 3600) { // 1h
                                return localTime.toLocaleTimeString('en-US', { 
                                    hour12: false, 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            } else { // 6h and 24h
                                return localTime.toLocaleDateString('en-US', { 
                                    month: '2-digit', 
                                    day: '2-digit' 
                                }) + ' ' + localTime.toLocaleTimeString('en-US', { 
                                    hour12: false, 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                            }
                        }
                    },
                    gridLineColor: 'rgba(255,255,255,0.1)'
                },
                yAxis: {
                    title: { text: 'L/min', style: { color: '#fff' } },
                    labels: { style: { color: '#ddd' } },
                    gridLineColor: 'rgba(255,255,255,0.1)',
                    min: 0
                },
                series: [
                    {
                        name: 'Toilet',
                        data: [],
                        color: colors.toilet,
                        animation: false
                    },
                    {
                        name: 'Faucet',
                        data: [],
                        color: colors.faucet,
                        animation: false
                    },
                    {
                        name: 'Garden',
                        data: [],
                        color: colors.garden,
                        animation: false
                    }
                ],
                legend: { 
                    itemStyle: { color: '#ccc' },
                    enabled: true
                },
                credits: { enabled: false },
                plotOptions: {
                    series: {
                        animation: false,
                        marker: {
                            enabled: selectedTimeRange <= 300 ? true : false,
                            radius: 2
                        }
                    }
                },
                tooltip: {
                    shared: true,
                    formatter: function() {
                        let tooltip = '<b>' + Highcharts.dateFormat('%H:%M:%S', this.x) + '</b><br/>';
                        this.points.forEach(point => {
                            tooltip += '<span style="color:' + point.color + '">' + point.series.name + 
                                    '</span>: <b>' + point.y.toFixed(2) + ' L/min</b><br/>';
                        });
                        return tooltip;
                    }
                }
            });

            // Device Distribution (Pie)
            deviceChart = Highcharts.chart('deviceChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent'
                },
                title: { text: 'Device Usage Distribution', style: { color: '#fff' } },
                series: [{
                    name: 'Usage',
                    colorByPoint: true,
                    data: []
                }],
                legend: { itemStyle: { color: '#ccc' } },
                credits: { enabled: false },
                plotOptions: {
                    pie: {
                        dataLabels: {
                            style: { color: '#fff' }
                        }
                    }
                }
            });

            // Daily Usage by Device (Bar)
            dailyChart = Highcharts.chart('dailyChart', {
                chart: {
                    type: 'column',
                    backgroundColor: 'transparent'
                },
                title: { text: 'Daily Usage (L)', style: { color: '#fff' } },
                xAxis: {
                    categories: devices.map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                    labels: { style: { color: '#ddd' } },
                    gridLineColor: 'rgba(255,255,255,0.1)'
                },
                yAxis: {
                    title: { text: 'Liters', style: { color: '#fff' } },
                    labels: { style: { color: '#ddd' } },
                    gridLineColor: 'rgba(255,255,255,0.1)',
                    min: 0
                },
                series: [{
                    name: 'Usage',
                    data: [],
                    showInLegend: false
                }],
                legend: { itemStyle: { color: '#ccc' } },
                credits: { enabled: false }
            });
        }

        // ======================
        // Fixed Chart Updates
        // ======================
        function updateCharts() {
            // Update chart title with current time range
            flowChart.setTitle({
                text: `Real-time Flow Rate (${timeRanges[selectedTimeRange].label})`
            });
            
            // Ensure data is in correct format for Highcharts
            // Data should be array of [timestamp, value] pairs
            const toiletData = (devicesData.toilet?.flow || []).map(point => {
                // Ensure each point is [timestamp, value]
                if (Array.isArray(point) && point.length >= 2) {
                    return [Number(point[0]), Number(point[1])];
                }
                return [Date.now(), 0];
            });
            
            const faucetData = (devicesData.faucet?.flow || []).map(point => {
                if (Array.isArray(point) && point.length >= 2) {
                    return [Number(point[0]), Number(point[1])];
                }
                return [Date.now(), 0];
            });
            
            const gardenData = (devicesData.garden?.flow || []).map(point => {
                if (Array.isArray(point) && point.length >= 2) {
                    return [Number(point[0]), Number(point[1])];
                }
                return [Date.now(), 0];
            });
            
            // Update flow chart with properly formatted data
            try {
                flowChart.series[0].setData(toiletData, false, false);
                flowChart.series[1].setData(faucetData, false, false);
                flowChart.series[2].setData(gardenData, true, false);
            } catch (e) {
                console.error('Error updating flow chart:', e);
                console.log('Data formats:', { toiletData, faucetData, gardenData });
            }

            // Update markers visibility based on time range
            const showMarkers = selectedTimeRange <= 300;
            flowChart.series.forEach(series => {
                series.update({
                    marker: {
                        enabled: showMarkers,
                        radius: 2
                    }
                }, false);
            });
            
            flowChart.redraw();

            // Update device distribution chart - ensure proper data format
            const pieData = devices.map((device, index) => {
                const value = devicesData[device]?.daily || 0;
                return {
                    name: device.charAt(0).toUpperCase() + device.slice(1),
                    y: Number(value), // Ensure it's a number
                    color: [colors.toilet, colors.faucet, colors.garden][index]
                };
            });
            
            try {
                deviceChart.series[0].setData(pieData, true);
            } catch (e) {
                console.error('Error updating pie chart:', e);
                console.log('Pie data format:', pieData);
            }

            // Update daily usage chart - ensure proper data format
            const barData = devices.map((device, index) => {
                const value = devicesData[device]?.daily || 0;
                return {
                    y: Number(value), // Ensure it's a number
                    color: [colors.toilet, colors.faucet, colors.garden][index]
                };
            });
            
            try {
                dailyChart.series[0].setData(barData, true);
            } catch (e) {
                console.error('Error updating bar chart:', e);
                console.log('Bar data format:', barData);
            }
        }

        function updateKPIs() {
            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

            // Update individual device flow rates (current/latest values)
            document.getElementById('flowRate1').textContent = 
                `${(devicesData.toilet?.flow.slice(-1)[0]?.[1] || 0).toFixed(1)} L/min`;
            document.getElementById('flowRate2').textContent = 
                `${(devicesData.faucet?.flow.slice(-1)[0]?.[1] || 0).toFixed(1)} L/min`;
            document.getElementById('flowRate3').textContent = 
                `${(devicesData.garden?.flow.slice(-1)[0]?.[1] || 0).toFixed(1)} L/min`;
            
            // Update individual device consumption
            document.getElementById('totalWater1').textContent = (devicesData.toilet?.daily || 0).toFixed(1);
            document.getElementById('totalWater2').textContent = (devicesData.faucet?.daily || 0).toFixed(1);
            document.getElementById('totalWater3').textContent = (devicesData.garden?.daily || 0).toFixed(1);

            // Update trend (calculate from recent data)
            const trendPercent = calculateTrend();
            const trendIcon = trendPercent >= 0 ? '↗' : '↘';
            document.getElementById('totalTrend').textContent = 
                `${trendIcon} ${Math.abs(trendPercent)}% vs yesterday`;

            // Update alerts based on flow rates
            updateAlerts();
        }

        function calculateTrend() {
            // Simple trend calculation based on current vs average flow
            const currentTotal = devices.reduce((sum, device) => {
                return sum + (devicesData[device]?.flow.slice(-1)[0]?.[1] || 0);
            }, 0);
            
            const avgFlow = devices.reduce((sum, device) => {
                const flowData = devicesData[device]?.flow || [];
                const avg = flowData.length > 0 ? 
                    flowData.reduce((s, point) => s + point[1], 0) / flowData.length : 0;
                return sum + avg;
            }, 0);
            
            if (avgFlow === 0) return 0;
            return ((currentTotal - avgFlow) / avgFlow * 100).toFixed(1);
        }

        function updateAlerts() {
            alertCount = 0;
            let alertDevice = '-';
            
            devices.forEach(device => {
                const currentFlow = devicesData[device]?.flow.slice(-1)[0]?.[1] || 0;
                if (currentFlow > 10) { // Alert threshold: 10 L/min
                    alertCount++;
                    alertDevice = device.charAt(0).toUpperCase() + device.slice(1);
                }
            });
            
            document.getElementById('alerts').textContent = alertCount;
            document.getElementById('alertDevice').textContent = alertDevice;
        }

        // ======================
        // Utility Functions
        // ======================
        function showLoading(show) {
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        function showError(message) {
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // ======================
        // Real-time Data Management
        // ======================
        async function fetchAndUpdateData() {
            try {
                // Get data for current time range from Supabase
                const data = await getDataFromSupabase(selectedTimeRange);
                
                if (data && data.length > 0) {
                    // Reset device data
                    devices.forEach(device => {
                        devicesData[device] = { flow: [], daily: 0 };
                    });
                    
                    // Process all data within time range
                    data.forEach(record => {
                        const timestamp = new Date(record.timestamp).getTime();
                        const deviceName = record.device_name;
                        const flowRate = record.flow_rate;
                        const totalConsumed = record.total_consumed;
                        
                        if (devices.includes(deviceName)) {
                            devicesData[deviceName].flow.push([timestamp, flowRate]);
                            devicesData[deviceName].daily = Math.max(devicesData[deviceName].daily, totalConsumed);
                        }
                    });
                }
        
        // ======================
        // Debug Function - Add this to help troubleshoot
        // ======================
        function debugDataFormats() {
            console.log('=== DEBUG DATA FORMATS ===');
            console.log('devicesData:', devicesData);
            console.log('allHistoricalData:', allHistoricalData);
            
            devices.forEach(device => {
                if (devicesData[device] && devicesData[device].flow) {
                    console.log(`${device} flow data sample:`, devicesData[device].flow.slice(0, 3));
                }
            });
            console.log('=== END DEBUG ===');
        }

        // ======================
        // Initialization
        // ======================
        async function initializeSystem() {
            try {
                showLoading(true);
                
                // Initialize device data structure
                devices.forEach(device => {
                    devicesData[device] = { flow: [], daily: 0 };
                    allHistoricalData[device] = [];
                });
                devicesData.all = { flow: [], daily: 0 };
                
                // Initialize charts
                initCharts();
                
                // Load initial data from Supabase
                await loadDataFromSupabase();
                
                // Update charts and KPIs
                updateCharts();
                updateKPIs();
                
                showLoading(false);
                
                console.log('System initialized successfully');
            } catch (error) {
                console.error('Error initializing system:', error);
                showError('Failed to initialize system');
                showLoading(false);
            }
        }

        window.onload = async () => {
            await initializeSystem();
            
        // Fetch data from Supabase every 15 seconds for real-time updates
        setInterval(fetchAndUpdateData, 3000);
        };
        </script>
    </body>
</html>
